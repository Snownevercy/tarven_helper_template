function t(t){if(!t||'待定'===t)return null;const e=t.match(/(\d{4})-(\d{2})-(\d{2})/);if(!e)return null;const n=parseInt(e[1],10),o=parseInt(e[2],10)-1,c=parseInt(e[3],10);return new Date(n,o,c)}function e(t,e,n){const o=Number(t)||0,c=Number(e)||0,r=Number(n)||0;return o*c*(1-_.clamp(r,0,1))}$(()=>{errorCatched(async()=>{await waitGlobalInitialized('Mvu'),eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,(n,o)=>{const c=_.get(o,'stat_data'),r=_.get(n,'stat_data');if(!r)return;console.info('[只读字段保护] ===== 开始处理变量更新 =====');const s=_.get(r,'世界.当前日期'),i=_.get(r,'主角.生日');if(s&&i&&'待定'!==s&&'待定'!==i){const e=function(e,n){const o=t(e),c=t(n);if(!o||!c)return null;let r=o.getFullYear()-c.getFullYear();const s=o.getMonth()-c.getMonth(),i=o.getDate()-c.getDate();return(s<0||0===s&&i<0)&&r--,r>=0?r:null}(s,i);null!==e?(_.set(r,'主角._年龄',e),console.info(`[只读字段保护] 计算年龄: 当前日期=${s}, 生日=${i}, 年龄=${e}`)):console.warn(`[只读字段保护] 年龄计算失败: 当前日期=${s}, 生日=${i}`)}const l=_.get(c,'世界.当前日期'),f=_.get(r,'世界.当前日期'),u=_.get(c,'公司账户._现金'),a=_.get(r,'公司账户.公账一次性变动'),g=_.get(c,'公司账户.固定成本'),b=_.get(c,'公司账户.运行项目');if(l&&f&&'待定'!==l&&'待定'!==f&&void 0!==u){const e=function(e,n){const o=t(e),c=t(n);if(!o||!c)return 0;if(c<=o)return 0;const r=o.getFullYear(),s=o.getMonth(),i=o.getDate(),l=c.getFullYear(),f=c.getMonth();let u=r,a=s;i>1&&(a++,a>11&&(a=0,u++));let g=0;for(;!(u>l||u===l&&a>f);){if(u===l&&a===f){g++;break}g++,a++,a>11&&(a=0,u++)}return g}(l,f);console.info(`[只读字段保护] 计算跨月数: 旧日期=${l}, 新日期=${f}, 跨月数=${e}`);const n=Number(_.get(g,'人力成本'))||0,o=Number(_.get(g,'房租'))||0,c=n+o;let s=0;const i={};if(b&&'object'==typeof b)for(const t in b){const e=b[t];if(e&&'object'==typeof e&&'_月毛利'in e){const n=Number(e._月毛利)||0;s+=n,i[t]=n}}const m=function(t,e,n,o,c){let r=Number(t)||0;if(r+=Number(e)||0,n>=1){const t=(Number(_.get(o,'人力成本'))||0)+(Number(_.get(o,'房租'))||0);let e=0;if(c&&'object'==typeof c)for(const t in c){const n=c[t];n&&'object'==typeof n&&'_月毛利'in n&&(e+=Number(n._月毛利)||0)}r-=t*n,r+=e*n}return r}(u,a,e,g,b);_.set(r,'公司账户._现金',m),0===e?console.info(`[只读字段保护] 计算公司现金(未跨月): 旧现金=${u}, 一次性变动=${a}, 新现金=${m}`):(console.info(`[只读字段保护] 计算公司现金(跨${e}个月): 旧现金=${u}, 一次性变动=${a}, 固定成本=${c}(${n}+${o}), 月毛利总和=${s}, 新现金=${m}`),Object.keys(i).length>0&&console.info(`[只读字段保护] 各项目月毛利详情: ${Object.entries(i).map(([t,e])=>`${t}=${e}`).join(', ')}`))}else void 0!==u&&(_.set(r,'公司账户._现金',u),console.warn(`[只读字段保护] 公司现金计算跳过(日期信息不完整): 旧日期=${l}, 新日期=${f}, 保持旧值=${u}`));const m=_.get(r,'公司账户.运行项目');if(m&&'object'==typeof m)for(const t in m){const n=m[t];if(n&&'object'==typeof n){const o=n.月销量,c=n.单价,s=n.边际成本率,i=e(o,c,s);_.set(r,`公司账户.运行项目.${t}._月毛利`,i),console.info(`[只读字段保护] 计算项目月毛利: 项目=${t}, 月销量=${o}, 单价=${c}, 边际成本率=${s}, 月毛利=${i}`)}}console.info('[只读字段保护] ===== 变量更新处理完成 =====')}),console.info('[只读字段保护] 脚本已加载，开始监听变量更新事件')})()});
//# sourceMappingURL=index.js.map