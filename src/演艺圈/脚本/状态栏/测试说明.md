# 状态栏脚本测试说明

## 代码位置

脚本已创建在：`src/演艺圈/脚本/状态栏/index.ts`

## 主要调整

1. **导入 Schema**：使用 `import { Schema } from '../../schema'` 导入变量结构定义
2. **等待 MVU 初始化**：使用 `waitGlobalInitialized('Mvu')` 和 `waitUntil` 等待 MVU 变量框架初始化完成
3. **使用 Schema 解析数据**：在 `getMvuDataSafe()` 中使用 `Schema.parse()` 来解析和验证变量数据
4. **调整变量路径**：
   - `主角.年龄` → `主角._年龄`（只读字段，显示时使用数字）
   - `价值分析.持有资产` → `个人账户.持有资产`（结构变为 `record<string, {数量: number}>`）
   - `价值分析.合约状态` → `个人账户.合约状态`
   - `价值分析.投资项目` → 已删除（不存在于新 schema）
   - `代表作品.影视作品/音乐作品/综艺作品` → `职业履历.作品名`（数组）
   - `代表作品.获取奖项` → `职业履历.获取奖项`（数组）
   - `叙事.标题` → 使用固定值 "逐梦演艺圈"
   - `叙事.引言` → 使用固定值 "在娱乐圈的浮沉中寻找自己的位置"

## 测试步骤

### 1. 编译脚本

在项目根目录运行：

```bash
pnpm watch
```

这将启动 webpack 监听模式，自动编译脚本。编译后的文件将位于 `dist/演艺圈/脚本/状态栏/index.js`

### 2. 在酒馆助手中导入脚本

#### 方法一：使用本地开发服务器（推荐用于测试）

1. 确保 `pnpm watch` 正在运行
2. 在酒馆助手的脚本库中，创建一个新脚本
3. 脚本内容填写：

   ```typescript
   import 'http://localhost:5500/dist/演艺圈/脚本/状态栏/index.js'
   ```

4. 保存并启用脚本

#### 方法二：使用构建后的文件

1. 运行 `pnpm build` 构建项目
2. 将 `dist/演艺圈/脚本/状态栏/index.js` 上传到可访问的网络位置（如 GitHub、CDN 等）
3. 在酒馆助手中导入脚本，使用网络链接：

   ```typescript
   import 'https://your-cdn-url.com/path/to/index.js'
   ```

### 3. 验证脚本运行

1. **检查控制台**：
   - 打开浏览器开发者工具（F12）
   - 查看 Console 标签，确认没有错误信息
   - 应该能看到脚本成功加载的日志

2. **检查界面显示**：
   - 脚本加载后，应该在页面上看到一个手机风格的状态栏界面
   - 界面默认位置在左上角，点击时钟可以切换位置
   - 界面应该显示主角的基本信息

3. **测试功能**：
   - **切换标签页**：点击底部的"档案"、"作品"、"人脉"、"情报"标签
   - **折叠/展开**：点击右上角的折叠按钮或点击折叠后的图标
   - **切换位置**：点击时钟切换界面位置（左上、右上、右下、左下）
   - **BGM 控制**：点击音量图标控制背景音乐

4. **测试数据更新**：
   - 在聊天中与 AI 对话，让 AI 更新变量（例如更新主角姓名、职业等）
   - 观察状态栏是否自动更新显示新的数据
   - 检查各个标签页的数据是否正确显示

### 4. 调试技巧

如果脚本没有正常工作：

1. **检查 MVU 变量框架**：
   - 确保 `src/演艺圈/脚本/变量结构/index.ts` 脚本已加载并运行
   - 在控制台输入 `window.Mvu` 检查 MVU 是否可用

2. **检查变量数据**：
   - 在控制台输入以下代码查看当前变量：

     ```javascript
     window.Mvu.getMvuData({ type: 'message', message_id: 'latest' })
     ```

   - 检查 `stat_data` 字段是否存在且包含数据

3. **检查 Schema 解析**：
   - 如果看到 Schema 解析错误，检查 `src/演艺圈/schema.ts` 是否与变量数据匹配
   - 确保所有必需字段都有默认值（使用 `.prefault()`）

4. **检查事件监听**：
   - 在控制台检查 `window.eventOn` 和 `window.Mvu.events` 是否可用
   - 确认变量更新事件是否正常触发

### 5. 常见问题

**Q: 状态栏显示"待定"或"无"**

- A: 检查变量是否已初始化。确保世界书中的 `[initvar]变量初始化勿开` 条目已启用并正确配置

**Q: 界面没有出现**

- A: 检查脚本是否正确加载，查看控制台是否有错误。确保 jQuery 已加载（脚本会等待 jQuery）

**Q: 数据不更新**

- A: 检查事件监听是否正确设置。确保 `Mvu.events.VARIABLE_UPDATE_ENDED` 事件正常触发

**Q: 编译错误**

- A: 检查 TypeScript 类型错误。确保所有导入路径正确，Schema 类型定义完整

## 代码结构说明

- `getMvuDataSafe()`: 安全获取并解析 MVU 变量数据
- `getVal()`: 从嵌套对象中安全获取值
- `renderModules`: 各个标签页的渲染函数
  - `home`: 显示主角档案和资产信息
  - `works`: 显示职业履历（作品和奖项）
  - `social`: 显示人脉关系
  - `world`: 显示世界信息和专业评估
- `initFatePhone()`: 初始化状态栏界面和事件监听

## 下一步

如果测试通过，你可以：

1. 根据需要调整界面样式和布局
2. 添加更多功能（如搜索、筛选等）
3. 优化数据展示格式
4. 添加更多交互功能
