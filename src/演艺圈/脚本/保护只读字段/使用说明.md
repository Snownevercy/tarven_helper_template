# 保护只读字段脚本 - 使用说明

## 脚本功能

本脚本用于保护 MVU 变量框架中的只读字段不被 AI 更新，并自动计算只读字段的值：

- `主角._年龄`：根据 `世界.当前日期` 和 `主角.生日` 自动计算
- `公司账户._现金`：根据固定成本、运行项目和一次性变动自动计算
- `公司账户.运行项目.${项目名}._月毛利`：根据 `月销量 * 单价 * (1 - 边际成本率)` 自动计算

## 导入方式

### 方式一：本地开发（推荐用于测试）

1. **启动本地开发服务器**
   
   在项目根目录运行：
   ```bash
   pnpm watch
   ```
   这将启动 webpack 监听模式，自动编译脚本到 `dist/演艺圈/脚本/保护只读字段/index.js`

2. **在酒馆助手中导入脚本**
   
   - 打开酒馆助手，进入脚本库
   - 点击"导入脚本"或"新建脚本"
   - 选择导入文件：`src/演艺圈/脚本/保护只读字段/导入到酒馆中/脚本-本地开发.json`
   - 或者手动创建脚本，内容填写：
     ```typescript
     import 'http://localhost:5500/dist/演艺圈/脚本/保护只读字段/index.js'
     ```
   - 保存并启用脚本

3. **实时修改**
   
   启用"酒馆助手-实时监听-允许监听"开关后，修改 `src/演艺圈/脚本/保护只读字段/index.ts` 文件，脚本会自动热重载。

### 方式二：GitHub 自动更新（推荐用于生产环境）

1. **确保 GitHub 仓库已配置**
   
   - 确保你的仓库是 `Snownevercy/tarven_helper_template`（如果不是，需要修改导入文件中的仓库名）
   - 确保已配置 GitHub Actions 权限：
     - 前往仓库 `Settings -> Actions -> General`
     - 将 `Workflow permissions` 设置为 `Read and write permissions`
     - 勾选 `Allow GitHub Actions to create and approve pull requests`

2. **推送代码到 GitHub**
   
   ```bash
   git add .
   git commit -m "更新保护只读字段脚本"
   git push origin main  # 或 master
   ```

3. **等待自动打包**
   
   - GitHub Actions 会自动运行 `bundle.yaml` 工作流
   - 工作流会自动打包代码到 `dist/` 文件夹
   - 自动创建版本 tag，让 jsdelivr 更快更新缓存
   - 你可以在 GitHub 仓库的 `Actions` 页面查看打包进度

4. **在酒馆助手中导入脚本**
   
   - 打开酒馆助手，进入脚本库
   - 点击"导入脚本"或"新建脚本"
   - 选择导入文件：`src/演艺圈/脚本/保护只读字段/导入到酒馆中/脚本-GitHub自动更新.json`
   - 或者手动创建脚本，内容填写：
     ```typescript
     import 'https://testingcf.jsdelivr.net/gh/Snownevercy/tarven_helper_template@latest/dist/演艺圈/脚本/保护只读字段/index.js'
     ```
   - 保存并启用脚本

5. **自动更新**
   
   每次你 push 代码到 GitHub 后，脚本会自动打包并更新。jsdelivr 会在 12 小时内更新缓存（如果使用版本号）或 7 天内更新缓存（如果使用 @latest）。

## 注意事项

1. **本地开发服务器端口**
   
   默认使用 `localhost:5500`，如果你的开发服务器使用其他端口，需要修改导入文件中的 URL。

2. **GitHub 仓库名**
   
   如果仓库名不是 `Snownevercy/tarven_helper_template`，需要修改导入文件中的仓库名。

3. **版本号 vs @latest**
   
   - 使用版本号（如 `@v1.0.0`）：jsdelivr 会在 12 小时内更新缓存
   - 使用 `@latest`：jsdelivr 会在 7 天内更新缓存
   
   自动打包工作流会自动创建版本 tag，建议使用版本号以获得更快的更新速度。

4. **脚本依赖**
   
   本脚本依赖 MVU 变量框架，确保已正确配置 MVU 相关设置。

## 故障排查

### 本地开发无法加载脚本

- 检查 `pnpm watch` 是否正在运行
- 检查浏览器控制台是否有错误信息
- 确认 `dist/演艺圈/脚本/保护只读字段/index.js` 文件是否存在
- 确认本地开发服务器端口是否为 5500

### GitHub 自动更新不工作

- 检查 GitHub Actions 是否正常运行
- 检查仓库的 Actions 权限设置
- 查看 GitHub Actions 日志，确认是否有错误
- 确认仓库名是否正确

### 脚本功能不生效

- 检查浏览器控制台的日志，脚本会输出 `[只读字段保护]` 开头的日志
- 确认 MVU 变量框架已正确初始化
- 检查变量路径是否正确（如 `世界.当前日期`、`主角.生日` 等）
